
# Node.js recruitment task

## Main Description

Simple Movie API allows authorized users to add and fetch movies with movie details from the OMDB api.

**There are a few key points in this Movie API:**
1. There are two small node based microservices: Movies and Auth Services. 
- Authentication Service - to auth users and provide them with a JWT token.
- Movies Service - to handle movies data due to adding movies based on a title and fetching them further.
2. The Auth service and the Movies service are two different applications. They communicate with each other by HTTP protocol.
3. Creating and fetching movies data is protected and Authorization token is required.
4. Token should be passed in request's Authorization header to be authorized.
5. The API service is dockerized. Also API and Auth services are dockerized together. Make sure to have docker and docker-compose installed. 
6. By default the movies service starts on port 3001 and auth service starts on port 3000.

**Three containers were created:**
1. The Auth service
2. The Movie API service
3. MongoDB

**Basic links:**
A description of the original assignment is here: [Recruitment-Task].
The source code of Movie service you can find in movie-service/src. Auth service code is located under auth-service/src directory.
Documentation about the API is autogenerated with Swagger and it is available under the `http://0.0.0.0:3001/api/v0/api-docs` (in docker toolbox it is 
`http://192.168.99.101:3001/api/v0/api-docs`) endpoint.

### Run locally
- Clone this repository:
```
git clone https://github.com/anthonySensei/nodejs-recruitment-task.git
```
- Run containers from root dir (first time it will build images automatically):
```
JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY> docker-compose up -d
```` 
(optional) you can specify ports:
```
MOVIE_SVC_PORT=<MOVIE_SVC_PORT> AUTH_SVC_PORT=<AUTH_SVC_PORT> JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY> docker-compose up -d
```
Assume `Docker Toolbox` users should run:
```
AUTH_SVC_HOST=192.168.99.101 JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY>  docker-compose up -d
```
(optional) or with custom ports:
```
AUTH_SVC_HOST=192.168.99.101 MOVIE_SVC_PORT=<MOVIE_SVC_PORT> AUTH_SVC_PORT=<AUTH_SVC_PORT> JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY>  docker-compose up -d
```
`JWT_SECRET` and `OMDB_API_KEY` are mandatory. Without `JWT_SECRET` Authorization will not work and without `OMDB_API_KEY` movies adding will not work. For `Docker Toolbox`
users `AUTH_SVC_HOST` is also required. `AUTH_SVC_HOST` is the host where docker containers will be located. `0.0.0.0` is the default value, you don't need to change it if
you running from terminal. If you running in `Docker Tookbox` `192.168.99.101:3001` will the be default value and you should run with set AUTH_SVC_HOST.
Also if your Auth is located in another host, you shoud set it. For example:

Also you can define another port for Auth Service `AUTH_SVC_PORT`, and Movie Service `MOVIE_SVC_PORT`:
```
AUTH_SVC_HOST=<AUTH_SVC_HOST> MOVIE_SVC_PORT=<MOVIE_SVC_PORT> AUTH_SVC_PORT=<AUTH_SVC_PORT> JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY>  docker-compose up -d
```
- To stop the services run use: `docker-compose down`


## Authentication service

The auth service defines two user accounts that can be used:
- basic can add five movies per calendar month and fetch movie list unlimited times. 
- premium have no limits: can add unlimited number movies per month and fetch movie list unlimited times.

To authorize user call the auth service using curl or postman or swagger.

**You can start Authentication service separetly** under auth-service folder (specify the same JWT_SECRET variable value as the one you use to run the movies service):
```
JWT_SECRET=<YOUR_SECRET> docker-compose up -d
```
(optional) or with custom port
```
APP_PORT=<PORT> JWT_SECRET=<YOUR_SECRET> docker-compose up -d
```
**To stop the auth service**, press ctrl + c or run docker-compose down if docker is running in the background.

**Users credentials**
```
{
    "username": "basic-thomas",
    "password": "sR-_pcoow-27-6PAwCD8"
}
```
```
{
    "username": "premium-jim",
    "password": "GBLtTyq3E_UNjFnpo9m6"
}
```

**Example request**

Request:
```
curl --location --request POST '0.0.0.0:3000/auth' \
--header 'Content-Type: application/json' \
--data-raw '{
    "username": "basic-thomas",
    "password": "sR-_pcoow-27-6PAwCD8"
}'
```
or `premium`user
```
curl --location --request POST '0.0.0.0:3000/auth' \
--header 'Content-Type: application/json' \
--data-raw '{
    "username": "premium-jim",
    "password": "GBLtTyq3E_UNjFnpo9m6"
}'
```
Response:
```
{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTYyNTQ5MTI4MywiZXhwIjoxNjI1NDkzMDgzLCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.jmZgZAadfcpo82dsfxn7TvKBhw5uN9nq34WgKGgOcus"
}
```
## Movies service

The Movies service:
- takes a token that is obtained from the auth service
- allows to add movies and requires only a title from user
- fetches from the OMDB api additional movie details (based on title) and saves them to the database.
- return all movies which have been added by user

The Movies service contains an express server and a mongodb database.

There are several important points:
1. To add or fetch movies user need to be authorized.
2. Basic users can add five movies per calendar month and fetch movie list unlimited times.
3. Premium users have no limits: can add unlimited number movies per month and fetch movie list unlimited times.

To add a movie or to get user movies call service using for example curl or postman  or swagger.

**You can start Movies API service separetly** under movies-service folder (specify the same JWT_SECRET variable value as the one you use to run the auth service):
```
JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<OMDB_API_KEY> docker-compose up -d
```
(optional) or with custom ports:
```
APP_PORT=<PORT> AUTH_SVC_PORT=<AUTH_SVC_PORT> JWT_SECRET=<YOUR_SECRET> docker-compose up -d
```
(depends on environment) or with custom Auth Service host:
```
AUTH_SVC_PORT=<AUTH_SVC_PORT> AUTH_SVC_HOST=<AUTH_SVC_HOST> JWT_SECRET=<YOUR_SECRET> docker-compose up -d
```

**Example POST**
Request:
```
curl --location --request POST '0.0.0.0:3001/api/v0/movies' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTYyNTQ5MTI4MywiZXhwIjoxNjI1NDkzMDgzLCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.jmZgZAadfcpo82dsfxn7TvKBhw5uN9nq34WgKGgOcus' \
--header 'Content-Type: application/json' \
--data-raw '{
    "title": "Interstellar"
}'
```
Response:
```
{
    "message": "Movie 'Marvel' has been successfully added"
}
```

**Example GET**
Request:
```
curl --location --request GET '0.0.0.0:3001/api/v0/movies' \
--header 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEyMywibmFtZSI6IkJhc2ljIFRob21hcyIsInJvbGUiOiJiYXNpYyIsImlhdCI6MTYyNTQ5MTI4MywiZXhwIjoxNjI1NDkzMDgzLCJpc3MiOiJodHRwczovL3d3dy5uZXRndXJ1LmNvbS8iLCJzdWIiOiIxMjMifQ.jmZgZAadfcpo82dsfxn7TvKBhw5uN9nq34WgKGgOcus'
```
Response:
```
{
    "movies": [
        {
            "_id": "60e30941ab17870014155e8f",
            "title": "Interstellar",
            "release": "Fri Nov 07 2014 00:00:00 GMT+0000 (Coordinated Universal Time)",
            "genre": "Adventure, Drama, Sci-Fi",
            "director": "Christopher Nolan"
        }
    ]
}
```

## Tests
### Movies service

**Run tests locally**
Clone this repository:
```
git clone https://github.com/anthonySensei/nodejs-recruitment-task.git
```
Run from `movie-service` dir:
With docker:
```
JWT_SECRET=<YOUR_SECRET> OMDB_API_KEY=<YOUR_OMDB_API_KEY> docker-compose run --rm app npm test
```
or with npm
```
npm run dev-test
```

Code coverage is 92%.

### Continuous Integration

Projet uses Github Actions for Continuous Integration and Deployment.
After each pull request the Test pipeline is executed and code testing is started.
On direct pushes to master or when a PR is merged the Test & Deploy pipeline is executed.
This pipeline, after running the tests, deploys container to Docker Hub. Dockerhub repo: `https://hub.docker.com/repository/docker/anthonysensei13/movie-api`.


### API docs (swagger)
Defaults swagger is located in `http://<host>:<port>/api/v0/api-docs`. For example:
```
http://0.0.0.0:3001/api/v0/api-docs
```

**Swagger UI**

![Swagger UI](docs/swagger_ui.png?raw=true "Swagger UI")

####Auth

**First of all** you should authorize, because without authorization you will get 401 error:
- Go to `Auth` module and expand `POST /auth`. Fill in data and click on `Execute`:
![Auth Panel](docs/auth_panel.png?raw=true "Auth Panel")
If credentials is correct, you will get authorization token:
![Auth Reponse](docs/auth_response.png?raw=true "Auth Response")
- Copy authorization token.
- Scroll to up, click on `Authorize` button:
![Authorize](docs/authorize.png?raw=true "Authorize")
- Popup will open. Enter token to field:
```
Bearer <AUTH_TOKEN>
```
Click on `Authorize`:
![Authorize Popup](docs/authorize_popup.png?raw=true "Authorize Popup")
**NOW YOU ARE AUTHORIZED!**

#### Movies

1. Add Movies.
**To add movie** expand `POST /api/v0/movies`, fill in data and click on `Execute`:
![Add Movie](docs/add_movie.png?raw=true "Add Movie")
If movie is added, you will see it when you fetch movies.
2. Get Movies.
**To fetch movies** expand `Get /api/v0/movies` and click on `Execute`:
![Get Movies](docs/add_movie.png?raw=true "Get Movies")
**YOU FETCH YOUR MOVIES**

## Technology stack

- TypeScript
- Node.js
- Express
- MongoDB
- Axios
- Mocha
- Chai
- Sinon
- Web Token
- Docker
- Swagger



[Recruitment-Task]: <https://github.com/netguru/nodejs-recruitment-task>

